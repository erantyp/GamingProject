<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ê°• ê±´ë„ˆê¸° í¼ì¦ â›µ (Stages, Fixed)</title>
<style>
  :root {
    --bg:#f4fbff; --ink:#1f2937; --muted:#64748b; --accent:#0ea5e9;
    --good:#16a34a; --bad:#ef4444; --card:#ffffffcc;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans,Apple SD Gothic Neo,"Malgun Gothic",sans-serif;background:var(--bg);color:var(--ink)}
  .hidden{display:none !important}

  .center-col{min-height:100dvh;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px}

  /* Buttons */
  .btn{padding:12px 18px;border-radius:14px;border:1px solid #dbe5ef;font-size:18px;font-weight:700;cursor:pointer;background:#fff;
       box-shadow:0 6px 14px rgba(0,0,0,.06);transition:transform .15s ease,box-shadow .15s ease}
  .btn:hover{transform:translateY(-2px);box-shadow:0 12px 20px rgba(0,0,0,.1)}
  .btn.primary{background:linear-gradient(180deg,#38bdf8,#0ea5e9);color:#fff;border:none}
  .btn.small{font-size:15px;padding:8px 12px}
  .btn.next{background:linear-gradient(180deg,#34d399,#059669);color:#fff;border:none}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:100}
  .modal{background:#fff;border-radius:16px;padding:20px;max-width:600px;box-shadow:0 20px 50px rgba(0,0,0,.3)}
  .modal h3{margin:0 0 8px} .modal p{margin:0;line-height:1.6;color:var(--muted)}

  /* Board */
  .container{max-width:1100px;margin:0 auto;padding:20px}
  .hud{display:flex;justify-content:space-between;align-items:center;margin:10px 0 18px;flex-wrap:wrap}
  .pill{padding:6px 10px;border-radius:999px;background:#eef6ff;color:#1d4ed8;border:1px solid #c7dbff;font-weight:700}

  .board{position:relative;width:100%;height:540px;border-radius:18px;overflow:hidden;border:1px solid #e5e7eb;background:#bfe8ff;
         box-shadow:0 10px 24px rgba(0,0,0,.06)}

  /* River (static, wavy edges via layered gradients) */
  .river{
    position:absolute;top:0;bottom:0;left:50%;transform:translateX(-50%);width:40%;
    background:
      radial-gradient(120px 60px at 10% 15%, #ffffff60 0 60%, transparent 61%) repeat-y,
      radial-gradient(120px 60px at 90% 35%, #ffffff50 0 60%, transparent 61%) repeat-y,
      linear-gradient(180deg,#8dd7ff,#54b9f0 60%,#4aa8e0);
    background-size: 100% 160px, 100% 220px, cover;
    background-position: 0 0, 0 40px, 0 0;
    border-left: 6px solid #9dd3ff55;
    border-right: 6px solid #9dd3ff55;
  }

  /* Banks */
  .bank{
    position:absolute;top:0;bottom:0;width:30%;display:flex;flex-direction:column;justify-content:flex-end;gap:8px;padding:10px 12px;
    background:linear-gradient(#cfe9a6,#a7d47d);
    box-shadow:inset 0 10px 18px rgba(0,0,0,.22), inset 0 -10px 14px rgba(0,0,0,.12);
  }
  .bank.left{left:0;} .bank.right{right:0;}
  .bank-title{position:absolute;top:8px;left:50%;transform:translateX(-50%);font-weight:800;background:#ffffffcc;padding:2px 10px;border-radius:999px}
  .dock{display:flex;flex-wrap:wrap;gap:8px;z-index:2}

  /* Boat motion */
  .boat-wrap{position:absolute;top:55%;transform:translate(-50%,-50%);transition:left 1.1s cubic-bezier(0.65,0,0.35,1);}
  .boat-wrap.moving{animation:bob 0.5s ease-in-out infinite alternate;}
  @keyframes bob {from{transform:translate(-50%,-50%) rotate(-1deg)} to{transform:translate(-50%,-52%) rotate(1deg)}}
  .boat{position:relative;width:320px;max-width:80%;height:110px;background:#8b5a2b;border-radius:12px;
        box-shadow:0 12px 0 #5a3817 inset,0 -8px 0 #b37a43 inset,0 20px 40px rgba(0,0,0,.25)}
  .slots{position:absolute;left:8px;right:8px;bottom:8px;height:88px;display:flex;gap:10px;justify-content:center;align-items:flex-end}
  .slot{width:80px;height:80px;border:2px dashed #ffffff99;border-radius:12px;background:#ffffff22;
        display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}

  /* Tokens */
  .token{width:80px;height:80px;border-radius:16px;background:var(--card);border:1px solid #e5e7eb;
         box-shadow:0 6px 12px rgba(0,0,0,.08);display:flex;align-items:center;justify-content:center;font-size:42px;
         cursor:grab;transition:transform .1s ease;}
  .token:hover{transform:scale(1.05)}
  .token:active{cursor:grabbing}

  /* Overlay */
  .result{position:absolute;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:10}
  .result .card{background:#fff;border-radius:18px;padding:24px;width:min(520px,88vw);text-align:center;box-shadow:0 24px 80px rgba(0,0,0,.35)}
  .result h2{margin:0 0 10px} .result p{margin:6px 0 16px;color:var(--muted)}

  @media (max-width: 720px){
    .board{height:560px}
    .token{width:72px;height:72px;font-size:36px}
    .slot{width:72px;height:72px}
  }
</style>
</head>
<body>

<!-- ì´ˆê¸° ë©”ë‰´ -->
<main id="menu" class="center-col">
  <h1>ê°• ê±´ë„ˆê¸° í¼ì¦ â›µ</h1>
  <button class="btn primary" id="startBtn">ğŸš€ ê²Œì„ ì‹œì‘</button>
</main>

<!-- ê·œì¹™ ëª¨ë‹¬ -->
<div id="rulesModal" class="modal-backdrop">
  <div class="modal">
    <h3>ê²Œì„ ê·œì¹™</h3>
    <p id="ruleText"></p>
    <div style="margin-top:14px;text-align:right">
      <button class="btn small primary" id="closeRules">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- ê²Œì„ í™”ë©´ -->
<section id="game" class="container hidden">
  <div class="hud">
    <div class="left">
      <span class="pill">ìŠ¤í…Œì´ì§€: <b id="stageName"></b></span>
      <span class="pill">ë³´íŠ¸ ìœ„ì¹˜: <b id="boatSideLabel"></b></span>
      <span class="pill">ê²½ê³¼ì‹œê°„: <b id="elapsed">00:00</b></span>
    </div>
    <div class="right">
      <button class="btn small ghost" id="rulesBtn">ğŸ“œ ê·œì¹™</button>
      <button class="btn small ghost" id="resetBtn">â†º ë¦¬ì…‹</button>
      <button class="btn small primary" id="moveBtn">â›µ ì´ë™</button>
    </div>
  </div>

  <div class="board">
    <div class="bank left"><div class="bank-title">ì™¼ìª½ ë‘‘</div><div class="dock" id="dock-left"></div></div>
    <div class="river"></div>
    <div class="boat-wrap" id="boatWrap">
      <div class="boat" id="boat">
        <div class="slots">
          <div class="slot" id="slotA">ì‚¬ëŒ</div>
          <div class="slot" id="slotB">í™”ë¬¼</div>
        </div>
      </div>
    </div>
    <div class="bank right"><div class="bank-title">ì˜¤ë¥¸ìª½ ë‘‘</div><div class="dock" id="dock-right"></div></div>

    <!-- ê²°ê³¼ -->
    <div class="result" id="overlay">
      <div class="card">
        <h2 id="overlayTitle"></h2>
        <p id="overlayMsg"></p>
        <p id="timeMsg"></p>
        <button class="btn next" id="nextBtn">ë‹¤ìŒ ìŠ¤í…Œì´ì§€</button>
        <button class="btn primary" id="replayBtn">ë‹¤ì‹œ ë„ì „</button>
        <button class="btn" id="homeBtn">ì²˜ìŒìœ¼ë¡œ</button>
      </div>
    </div>
  </div>
</section>

<script>
/* ================== Stage definitions ================== */
const STAGES = [
  {
    name:"1ë‹¨ê³„ Â· ëŠ‘ëŒ€-ì–‘-ì–‘ë°°ì¶”",
    tokens:["person","wolf","goat","cabbage"],
    capacity:2, // ì‚¬ëŒ + 1ê°œ
    requiresPerson:true,
    ruleText:"ë³´íŠ¸ì—ëŠ” ë°˜ë“œì‹œ ì‚¬ëŒì´ íƒ€ì•¼ í•˜ë©°, í•œ ë²ˆì— ì‚¬ëŒê³¼ í•¨ê»˜ 1ê°œë§Œ ì˜®ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‚¬ëŒì´ ì—†ëŠ” ë‘‘ì— ëŠ‘ëŒ€+ì–‘ ë˜ëŠ” ì–‘+ì–‘ë°°ì¶”ê°€ ë‚¨ìœ¼ë©´ ê²Œì„ ì˜¤ë²„!",
    checkFail:(positions,boatSide)=>{
      const bank={L:[],R:[]};
      for(const t in positions){
        const side = positions[t]==='BOAT' ? boatSide : positions[t];
        bank[side].push(t);
      }
      if(!bank.L.includes('person')){
        if(bank.L.includes('wolf')&&bank.L.includes('goat'))return"ì™¼ìª½ ë‘‘ì—ì„œ ëŠ‘ëŒ€ê°€ ì–‘ì„ ë¨¹ì—ˆìŠµë‹ˆë‹¤!";
        if(bank.L.includes('goat')&&bank.L.includes('cabbage'))return"ì™¼ìª½ ë‘‘ì—ì„œ ì–‘ì´ ì–‘ë°°ì¶”ë¥¼ ë¨¹ì—ˆìŠµë‹ˆë‹¤!";
      }
      if(!bank.R.includes('person')){
        if(bank.R.includes('wolf')&&bank.R.includes('goat'))return"ì˜¤ë¥¸ìª½ ë‘‘ì—ì„œ ëŠ‘ëŒ€ê°€ ì–‘ì„ ë¨¹ì—ˆìŠµë‹ˆë‹¤!";
        if(bank.R.includes('goat')&&bank.R.includes('cabbage'))return"ì˜¤ë¥¸ìª½ ë‘‘ì—ì„œ ì–‘ì´ ì–‘ë°°ì¶”ë¥¼ ë¨¹ì—ˆìŠµë‹ˆë‹¤!";
      }
      return null;
    }
  },
  {
    name:"2ë‹¨ê³„ Â· ì„ êµì‚¬-ì‹ì¸ì¢…",
    tokens:["M1","M2","M3","C1","C2","C3"],
    capacity:2, // ë‘ ëª…ê¹Œì§€
    requiresPerson:false,
    ruleText:"ë°°ì—ëŠ” ìµœëŒ€ 2ëª…ê¹Œì§€ íƒˆ ìˆ˜ ìˆìœ¼ë©°, ì–´ëŠ ë‘‘ì—ì„œë“  ì„ êµì‚¬ê°€ 1ëª… ì´ìƒ ìˆì„ ë•Œ ì‹ì¸ì¢… ìˆ˜ê°€ ì„ êµì‚¬ ìˆ˜ë¥¼ ë„˜ìœ¼ë©´ ê²Œì„ ì˜¤ë²„!",
    checkFail:(positions,boatSide)=>{
      const count={L:{M:0,C:0},R:{M:0,C:0}};
      for(const t in positions){
        const side = positions[t]==='BOAT' ? boatSide : positions[t];
        if(t.startsWith('M')) count[side].M++; else count[side].C++;
      }
      for(const side of ['L','R']){
        if(count[side].M>0 && count[side].C>count[side].M){
          return `${side==='L'?'ì™¼ìª½':'ì˜¤ë¥¸ìª½'} ë‘‘ì—ì„œ ì‹ì¸ì¢…ì´ ì„ êµì‚¬ë¥¼ ì¡ì•„ë¨¹ì—ˆìŠµë‹ˆë‹¤!`;
        }
      }
      return null;
    }
  }
];

/* ================== State ================== */
const $ = s => document.querySelector(s);
const leftDock = $('#dock-left'), rightDock = $('#dock-right');
const boatWrap = $('#boatWrap'), boat = $('#boat');
const slotA = $('#slotA'), slotB = $('#slotB');

let state = {
  stageIndex: 0,
  positions: {},         // name -> 'L'|'R'|'BOAT'
  boatSide: 'L',         // 'L'|'R'
  moving: false,
  startTs: null,
  timerId: null
};

function boatLeftPercent(side){ return side==='L' ? 36 : 64; }
function emoji(name){
  if(name==='person')return'ğŸ§';
  if(name==='wolf')return'ğŸº';
  if(name==='goat')return'ğŸ‘';
  if(name==='cabbage')return'ğŸ¥¬';
  return name.startsWith('M')?'ğŸ§‘â€ğŸ¦³':'ğŸ§›';
}

/* ================== Init / Stage control ================== */
function startStage(idx){
  const st = STAGES[idx];
  state.stageIndex = idx;
  state.positions = {};
  st.tokens.forEach(t => state.positions[t]='L');
  state.boatSide = 'L';
  state.moving = false;

  // ë³´íŠ¸ ì´ˆê¸° ì¢Œí‘œ
  boatWrap.style.left = boatLeftPercent('L') + '%';

  // ìŠ¬ë¡¯ ë¼ë²¨(1ë‹¨ê³„: ì‚¬ëŒ/í™”ë¬¼, 2ë‹¨ê³„: ì¢Œì„1/ì¢Œì„2)
  if(st.requiresPerson){
    slotA.textContent = 'ì‚¬ëŒ'; slotB.textContent = 'í™”ë¬¼';
  }else{
    slotA.textContent = 'ì¢Œì„1'; slotB.textContent = 'ì¢Œì„2';
  }

  $('#stageName').textContent = st.name;
  $('#ruleText').textContent = st.ruleText;
  $('#boatSideLabel').textContent = 'ì™¼ìª½ ë‘‘';
  hideOverlay();
  startTimer();
  render();
}

function enterGame(){
  $('#menu').classList.add('hidden');
  $('#game').classList.remove('hidden');
  window.scrollTo({top:0,behavior:'smooth'});
  startStage(0);
}

function enterMenu(){
  $('#menu').classList.remove('hidden');
  $('#game').classList.add('hidden');
  stopTimer();
}

/* ================== Timer ================== */
function startTimer(){
  state.startTs = Date.now();
  clearInterval(state.timerId);
  state.timerId = setInterval(()=>{
    $('#elapsed').textContent = formatTime(Date.now()-state.startTs);
  }, 250);
}
function stopTimer(){ clearInterval(state.timerId); state.timerId=null; }
function formatTime(ms){ const s=Math.floor(ms/1000), m=Math.floor(s/60); return `${m.toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`; }

/* ================== Rendering ================== */
function makeToken(name){
  const el = document.createElement('div');
  el.className = 'token'; el.draggable = true; el.dataset.id = name;
  el.textContent = emoji(name);
  el.addEventListener('dragstart', e=>{
    if(state.moving){ e.preventDefault(); return; }
    e.dataTransfer.setData('text/plain', name);
  });
  return el;
}

function clearSlots(){
  // ì™„ì „ ì´ˆê¸°í™” â†’ ë³µì‚¬ ë²„ê·¸ ë°©ì§€
  leftDock.replaceChildren();
  rightDock.replaceChildren();
  slotA.replaceChildren();
  slotB.replaceChildren();
}

function render(){
  clearSlots();
  const st = STAGES[state.stageIndex];

  // í† í° ë°°ì¹˜
  for(const name of st.tokens){
    const pos = state.positions[name];
    const el = makeToken(name);

    if(pos==='L'){ leftDock.appendChild(el); }
    else if(pos==='R'){ rightDock.appendChild(el); }
    else if(pos==='BOAT'){
      if(st.requiresPerson){
        // 1ë‹¨ê³„: ì‚¬ëŒì€ A, í™”ë¬¼ì€ B
        if(name==='person') slotA.appendChild(el);
        else slotB.appendChild(el);
      }else{
        // 2ë‹¨ê³„: ì¢Œì„1 ìš°ì„ , ê½‰ ì°¨ë©´ ì¢Œì„2
        (slotA.childElementCount===0 ? slotA : slotB).appendChild(el);
      }
    }
  }

  // ë¹ˆ ìŠ¬ë¡¯ ë¼ë²¨ ë³µì›
  if(slotA.childElementCount===0) slotA.textContent = st.requiresPerson ? 'ì‚¬ëŒ' : 'ì¢Œì„1';
  if(slotB.childElementCount===0) slotB.textContent = st.requiresPerson ? 'í™”ë¬¼' : 'ì¢Œì„2';

  // ë¼ë²¨/ì¢Œí‘œ
  $('#boatSideLabel').textContent = state.boatSide==='L'?'ì™¼ìª½ ë‘‘':'ì˜¤ë¥¸ìª½ ë‘‘';
  boatWrap.style.left = boatLeftPercent(state.boatSide) + '%';

  // ì—”ë“œ ìŠ¤í…Œì´íŠ¸ íŒì •
  const fail = st.checkFail(state.positions, state.boatSide);
  if(fail){ showOverlay(false, fail); return; }
  if(Object.values(state.positions).every(v => v==='R')){
    showOverlay(true, 'ì„±ê³µ!');
  }
}

/* ================== Drag & Drop (boat/docksë§Œ í—ˆìš©) ================== */
function currentBoatCount(){ return Object.values(state.positions).filter(v=>v==='BOAT').length; }
function currentBoatNonPerson(){ return Object.entries(state.positions).filter(([k,v])=>v==='BOAT' && k!=='person').length; }

boat.addEventListener('dragover', e=>{ if(!state.moving) e.preventDefault(); });
boat.addEventListener('drop', e=>{
  if(state.moving) return;
  e.preventDefault();
  const name = e.dataTransfer.getData('text/plain'); if(!name) return;
  const st = STAGES[state.stageIndex];

  // ê°™ì€ ë‘‘ì— ìˆê±°ë‚˜ ì´ë¯¸ ë³´íŠ¸ì— ìˆëŠ” ê²½ìš°ë§Œ
  const sameSide = (state.positions[name]===state.boatSide) || (state.positions[name]==='BOAT');
  if(!sameSide) return;

  // ìš©ëŸ‰ ì²´í¬ (ìƒˆë¡œ íƒœìš°ë ¤ëŠ” ê²½ìš°ì—ë§Œ)
  if(state.positions[name]!=='BOAT'){
    const count = currentBoatCount();
    if(count >= st.capacity) return;                // ìš©ëŸ‰ ì´ˆê³¼ ê¸ˆì§€
    if(st.requiresPerson && name!=='person' && currentBoatNonPerson()>=1) return; // 1ë‹¨ê³„ í™”ë¬¼ 1ê°œ ì œí•œ
  }

  // íƒ‘ìŠ¹/í•˜ì°¨ í† ê¸€
  state.positions[name] = (state.positions[name]==='BOAT') ? state.boatSide : 'BOAT';
  render();
});

[leftDock, rightDock].forEach(dock=>{
  dock.addEventListener('dragover', e=>{ if(!state.moving) e.preventDefault(); });
  dock.addEventListener('drop', e=>{
    if(state.moving) return;
    e.preventDefault();
    const name = e.dataTransfer.getData('text/plain'); if(!name) return;
    const targetSide = (dock===leftDock)?'L':'R';
    // ë³´íŠ¸ê°€ í•´ë‹¹ ë‘‘ì— ìˆì„ ë•Œë§Œ í•˜ì°¨ í—ˆìš©
    if(state.boatSide!==targetSide) return;
    if(state.positions[name]!=='BOAT') return;
    state.positions[name] = targetSide;
    render();
  });
});

/* ================== Boat move ================== */
function moveBoat(){
  if(state.moving) return;
  const st = STAGES[state.stageIndex];
  const boatCount = currentBoatCount();

  if(boatCount===0) return;
  if(st.requiresPerson && state.positions['person']!=='BOAT') return; // 1ë‹¨ê³„: ì‚¬ëŒ í•„ìˆ˜
  if(boatCount > st.capacity) return;

  state.boatSide = (state.boatSide==='L') ? 'R' : 'L';
  state.moving = true;
  boatWrap.classList.add('moving');
  boatWrap.style.left = boatLeftPercent(state.boatSide) + '%';

  setTimeout(()=>{
    boatWrap.classList.remove('moving');
    for(const k in state.positions){
      if(state.positions[k]==='BOAT') state.positions[k] = state.boatSide;
    }
    state.moving = false;
    render();
  }, 1100);
}

/* ================== Overlay ================== */
const overlay = $('#overlay'), overlayTitle = $('#overlayTitle'), overlayMsg = $('#overlayMsg'), timeMsg = $('#timeMsg');
const nextBtn = $('#nextBtn'), replayBtn = $('#replayBtn'), homeBtn = $('#homeBtn');

function showOverlay(success,msg){
  stopTimer();
  overlayTitle.textContent = success ? 'ğŸ‰ ì„±ê³µ!' : 'âŒ ì‹¤íŒ¨';
  overlayMsg.textContent = msg || (success?'ì„±ê³µí–ˆìŠµë‹ˆë‹¤!':'ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  timeMsg.textContent = `ê¸°ë¡: ${formatTime(Date.now()-state.startTs)}`;
  overlay.style.display = 'flex';

  // ë²„íŠ¼ í‘œì‹œ ì¡°ê±´
  nextBtn.style.display = (success && state.stageIndex < STAGES.length-1) ? 'inline-block' : 'none';
  homeBtn.style.display = (success && state.stageIndex === STAGES.length-1) ? 'inline-block' : 'none';
  replayBtn.style.display = 'inline-block';
}

function hideOverlay(){ overlay.style.display = 'none'; }

/* ================== Wire up ================== */
$('#startBtn').addEventListener('click', enterGame);
$('#rulesBtn').addEventListener('click', ()=>{ $('#ruleText').textContent = STAGES[state.stageIndex].ruleText; $('#rulesModal').style.display='flex'; });
$('#closeRules').addEventListener('click', ()=> $('#rulesModal').style.display='none');
$('#resetBtn').addEventListener('click', ()=> startStage(state.stageIndex));
$('#moveBtn').addEventListener('click', moveBoat);

nextBtn.addEventListener('click', ()=>{ hideOverlay(); startStage(state.stageIndex+1); });
replayBtn.addEventListener('click', ()=>{ hideOverlay(); startStage(state.stageIndex); });
homeBtn.addEventListener('click', ()=>{ hideOverlay(); enterMenu(); });

/* ================== Start ================== */
</script>
</body>
</html>
